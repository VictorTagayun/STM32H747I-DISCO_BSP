## Introduction and Purpose

** STM32H747XIH6 is a Dual core Cortex-M7 and Cortex-M4 MCU.
** The STM32H747I-DISCO Discovery kit is a complete demonstration and development platform for STMicroelectronics STM32H747XIH6 microcontroller, designed to simplify user application development. 
** Study how to init most peripherals by BSP Drivers. RCC and UART are the only peripherals initialized in CubeMX with 400Mhz (M7) & 200Mhz (M4) as this is the optimized freq for "most" peripherals espcially the LCD.

## CubeMX Initiallization RCC and UART (minimum)  

RCC =   

	RCC_OscInitStruct.PLL.PLLM = 5;  
	RCC_OscInitStruct.PLL.PLLN = 160;  
	RCC_OscInitStruct.PLL.PLLP = 2;  
	
	
### add BSP for GPIO, Button, Jostick and LED 

Copy these files to BSP inside CM7 driver folder   
	stm32h747i_discovery.c  
	stm32h747i_discovery.h  
	stm32h747i_discovery_conf.h  
	stm32h747i_discovery_errno.h  

add this into paths and symbols   
	Drivers\BSP\STM32H747I-DISCO  
	

note:  

Push button is an EXT IT and using a call back. So add manually these codes as it is not generated by CubeMX.  

in stm32h7xx_it.c /* USER CODE BEGIN 1 */ add 

	void EXTI15_10_IRQHandler(void)
	{
		BSP_PB_IRQHandler(BUTTON_WAKEUP);
	}

in main.c add 

	uint8_t CheckForUserInput(void)
	{
		Return ButtonState;
	}

	void BSP_PB_Callback(Button_TypeDef Button)
	{
		if(Button == BUTTON_WAKEUP)
		{

			ButtonState = 1;
		}
	}


### BSP for LCD also needs SDRAM and I2C (for DSI to HDMI, ADV7533)

Combine all BSP for LCD, SDRAM and I2C

copy these to Drivers\BSP\STM32H747I-DISCO in CM7 folder   
	stm32h747i_discovery_bus.c/h   
	stm32h747i_discovery_lcd.c/h  
	stm32h747i_discovery_sdram.c/h  

create Components folder Drivers\BSP in CM7 folder and copy these fodlers inside  
	is42s32800j  
	otm8009a  
	adv7533  
	
add ths into paths and symbols   
	Drivers\BSP\Components\ 

edit stm32h7xx_hal_conf.h enable and comment out these  
	#define HAL_DSI_MODULE_ENABLED  
	#define HAL_DMA2D_MODULE_ENABLED  
	#define HAL_LTDC_MODULE_ENABLED  
	#define HAL_SDRAM_MODULE_ENABLED  
	
copy these into Drivers\STM32H7xx_HAL_Driver folder, also link the files into project  
	stm32h7xx_hal_dma2d.c/h  
	stm32h7xx_hal_dsi.c/h  
	stm32h7xx_hal_ltdc.c/h  
	stm32h7xx_hal_ltdc_ex.c/h  
	stm32h7xx_hal_sdram.c/h  
	stm32h7xx_ll_fmc.c/h  
	
copy these files from BSP example to CM7 inc folder   
	is42s32800j_conf.h   
	lcd.h   
	stlogo.h   
	
copy functions from lcd.c	
	static void LCD_SetHint(void)   
	static void LCD_Show_Feature(uint8_t feature)   
	
in main.h add these   
	#include "stm32h747i_discovery_bus.h"  
	#include "stm32h747i_discovery_lcd.h"   
	#include "stm32h747i_discovery_sdram.h"   
	#include "stm32_lcd.h"   
	#include "stlogo.h"  
	#include <stdio.h>  
	
in lcd.c add   
	#include "stlogo.h" 
	
copy Utilities folder from BSP example to CM7 foldert  

add these in paths and symbols   
	Utilities/lcd   


### Test LCD  

	BSP_LCD_Init(0, LCD_ORIENTATION_LANDSCAPE);
	UTIL_LCD_SetFuncDriver(&LCD_Driver);
	UTIL_LCD_SetFont(&UTIL_LCD_DEFAULT_FONT);
	Display_DemoDescription();
	HAL_Delay(2000);

	LCD_SetHint();
	HAL_Delay(2000);

	for(uint32_t feature = 0; feature < 4; feature++)
	{
		LCD_Show_Feature(feature);
		HAL_Delay(1000);
	}


### Test SDRAM 

copy sdram.c to CM7 source

copy is42s32800j_conf.h from BSP example to CM7 inc

in sdram.c, change SDRAM_WRITE_READ_ADDR to SDRAM_DEVICE_ADDR  

in main.c add  
	extern void SDRAM_demo (void);
	extern void SDRAM_DMA_demo (void);

Test SDRAM  
	SDRAM_demo();  
	HAL_Delay(2000);  
	
	
### Test SDRAM DMA = to do, need to add DMA abd IT  

Test SDRAM (to do)  
	SDRAM_DMA_demo();  
	HAL_Delay(2000);
	
	
### Test QSPI  

copy qspi.c to CM7 source   

copy these to Drivers\BSP\STM32H747I-DISCO in CM7 folder   
	stm32h747i_discovery_qspi.c/h 

in main.h add this    
	#include "stm32h747i_discovery_qspi.h"  
	
edit stm32h7xx_hal_conf.h enable and comment out these  
	#define HAL_QSPI_MODULE_ENABLED
	
copy these into Drivers\STM32H7xx_HAL_Driver folder, also link the files into project  
	stm32h7xx_hal_qspi.c/h
	
create Components folder Drivers\BSP in CM7 folder and copy these fodlers inside  
	mt25tl01g   
	
copy is42s32800j_conf.h from BSP example to CM7 inc


### Test TouchScreen

copy touchscreen.c to CM7 source

copy these to Drivers\BSP\STM32H747I-DISCO in CM7 folder   
	stm32h747i_discovery_ts.c/h

in main.h add this    
	#include "stm32h747i_discovery_ts.h"  
	
edit stm32h7xx_hal_conf.h enable and comment out these  
	#define HAL_QSPI_MODULE_ENABLED
	
create Components folder Drivers\BSP in CM7 folder and copy these fodlers inside  
	ft6x06
	Common\ts.h
		
copy ft6x06_conf.h from BSP example to CM7 inc

copy few codes from Touchscreen_demo2(); to global variable  
	TS_Init_t *hTS;
	TS_Gesture_Config_t GestureConf;
	TS_State_t  VT_TS_State = {0};
	
copy to main.c main() few codes from Touchscreen_demo2();  
	uint32_t ts_status = BSP_ERROR_NONE;
	uint32_t x_size, y_size;

	BSP_LCD_GetXSize(0, &x_size);
	BSP_LCD_GetYSize(0, &y_size);

	hTS->Width = x_size;
	hTS->Height = y_size;
	hTS->Orientation = TS_SWAP_XY | TS_SWAP_Y;
	hTS->Accuracy = 5;

	GestureConf.Radian = 0x0A;
	GestureConf.OffsetLeftRight = 0x19;
	GestureConf.OffsetUpDown = 0x19;
	GestureConf.DistanceLeftRight = 0x19;
	GestureConf.DistanceUpDown = 0x19;
	GestureConf.DistanceZoom = 0x32;

	/* Touchscreen initialization */
	ts_status = BSP_TS_Init(0, hTS);
	ts_status = BSP_TS_GestureConfig(0, &GestureConf);

	if(ts_status == BSP_ERROR_NONE)
	{
		BSP_LED_On(LED_GREEN);
	} /* of if(status == BSP_ERROR_NONE) */

	// Paint Touch Screen while waiting user button to be pressed, polling mode
	while(ButtonState == 0)
	{
		BSP_TS_GetState(0, &VT_TS_State);

		if(VT_TS_State.TouchDetected)
		{
			/* One or dual touch have been detected          */
			/* Only take into account the first touch so far */

			/* Get X and Y position of the first touch post calibrated */
			x_ts = VT_TS_State.TouchX;
			y_ts = VT_TS_State.TouchY;

			UTIL_LCD_FillCircle(x_ts, y_ts, 5, UTIL_LCD_COLOR_BLACK);
		}
	}
	ButtonState = 0;
	

### STemWin Setup

add in main.c

	/* Configure the MPU attributes as Write Through for SDRAM*/
	MPU_Config();

	/* Enable the CPU Cache */
	CPU_CACHE_Enable();

	__HAL_RCC_CRC_CLK_ENABLE(); /* Enable the CRC Module */
	
Under CM7 folder, create folder Middlewares\ST\STemWin\inc add all *.h files
   
add to path "Includes"  
	Middlewares\ST\STemWin\inc
	
Copy all binary files   
	Middlewares\ST\STemWin\Lib

add to "library Paths"   
	Middlewares\ST\STemWin\Lib
	
add binary file in "libraries"
	:STemWin_CM7_wc32_ARGB.a
	
Note on "CM7\Core\Inc\lcd.h", rename to other files, it will conflict with "CM7\Middlewares\ST\STemWin\inc\LDC.h". It can be renamed to lcd_UTILS_Drv.h. Change recursive inclusion  
from   
	#ifndef LCD_H  
	#define LCD_H  
to   
	#ifndef LCD_UTILS_DRV_H   
	#define LCD_UTILS_DRV_H   

Note on "CM7\Utilities\lcd\stm32_lcd.c/h", add this code to include "lcd_UTILS_Drv.h"   
	#include "lcd_UTILS_Drv.h"

copy to Core\Src - usually these files are located in "STemWin\Target" folder except GUI_X.c is in "Middlewares\ST\STemWin\OS"   
	GUI_X.c - from example like "STemWin_helloworld" or repository  
	GUIConf.c - from example like "STemWin_helloworld", do not use repository as this will cause error and cannot fit in "RAM" 
	LCDConf.c - from example like "STemWin_helloworld" none in repository  
	
copy to Core\Inc - usually these files are located in "STemWin\Target" folder   
	GUIConf.h - from example like "STemWin_helloworld", repository missing #define GUI_USE_ARGB (1)    /* The color format to use is ABGR */  
	LCDConf.h - from example like "STemWin_helloworld" none in repository 
	
add in main.c   
	#include "WM.h"  
	#include "GUI.h"  
	
	
### STemWin "Hello World" example

copy "BASIC_HelloWorld.c" to "CM7\Core\Src"

in LCDConf.c comment the whole function   
	DSI_IO_WriteCmd(uint32_t NbrParams, uint8_t *pParams)

add in main.c   

	// pre STemWIN
	__HAL_RCC_CRC_CLK_ENABLE(); /* Enable the CRC Module */

	// STemWIN
	BSP_SDRAM_Init(0);
	GUI_Init();
	
** Hang up, troubleshooting

create SystemClock_Config2(), copy from other STemWIN examples, rename CubeMX SystemClock_Config() to SystemClock_Config2() = not working

in LCDConf.c comment the whole function = not working   
	DSI_IO_WriteCmd(uint32_t NbrParams, uint8_t *pParams)
	
removed "BSP_LCD_Init()" and other examples, immediately start with codes below, but GUI_Clear() is not runnot and subsequent GUI_DispStringAt() cannot run.   
	BSP_SDRAM_Init(0);
	GUI_Init();


### STemWin GUIBuilder 

enable GUI_Delay() by the ff steps:   
	
in stm32f7xx_it.c add   
	#include "GUI_ConfDefaults.h"  
	extern volatile GUI_TIMER_TIME OS_TimeMS; 
	
in stm32f7xx_it.c find void SysTick_Handler(void) add   
	OS_TimeMS++;
		
Copy WindowDLG.c

** Not showing WindowDLG, troubleshooting

Need to remove all codes, start the code by   
	BSP_SDRAM_Init(0);
	GUI_Init();
	// GUIBuilder
	CreateWindow();
	GUI_Exec();

